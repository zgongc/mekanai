{% extends "base.html" %}

{% block title %}Canvas - MekanAI{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/canvas.css') }}">
{% endblock %}

{% block content %}
<div class="canvas-workspace">

    <!-- ══════ Left Panel ══════ -->
    <div class="canvas-left">
      <div class="panel-sections-scroll">

        <!-- Prompt -->
        <div class="panel-section open">
            <div class="panel-section-header" onclick="toggleSection(this)">
                <span>Prompt</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="panel-section-body">
                <textarea id="promptInput" placeholder="Oluşturmak istediğiniz görseli detaylı açıklayın..." rows="4"></textarea>
            </div>
        </div>

        <!-- Negative Prompt -->
        <div class="panel-section">
            <div class="panel-section-header" onclick="toggleSection(this)">
                <span>Negatif Prompt</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="panel-section-body">
                <textarea id="negativePrompt" placeholder="İstemediğiniz öğeleri belirtin..." rows="3"></textarea>
            </div>
        </div>

        <!-- Model -->
        <div class="panel-section">
            <div class="panel-section-header" onclick="toggleSection(this)">
                <span>Model</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="panel-section-body">
                <label>Provider</label>
                <select id="providerSelect" onchange="filterModels()">
                    {% for p in providers %}
                    <option value="{{ p.id }}" data-key="{{ p.key }}">{{ p.name }}</option>
                    {% endfor %}
                </select>

                <label>Model</label>
                <select id="aiModel" onchange="applyModelDefaults()">
                    {% for m in ai_models %}
                    <option value="{{ m.key }}"
                            data-provider="{{ m.provider_id }}"
                            data-steps="{{ m.default_steps or '' }}"
                            data-cfg="{{ m.default_cfg_scale or '' }}"
                            data-sampler="{{ m.default_sampler or '' }}">{{ m.name }}</option>
                    {% endfor %}
                </select>

                <div class="settings-row">
                    <label>Steps</label>
                    <div class="range-group">
                        <input type="range" id="stepsRange" min="10" max="50" value="30" oninput="document.getElementById('stepsVal').textContent=this.value">
                        <span id="stepsVal">30</span>
                    </div>
                </div>

                <div class="settings-row">
                    <label>CFG Scale</label>
                    <div class="range-group">
                        <input type="range" id="cfgRange" min="1" max="20" step="0.5" value="7" oninput="document.getElementById('cfgVal').textContent=this.value">
                        <span id="cfgVal">7</span>
                    </div>
                </div>

                <div class="settings-row">
                    <label>Seed</label>
                    <div class="seed-group">
                        <input type="number" id="seedInput" value="-1" placeholder="-1 = rastgele">
                        <button type="button" class="seed-toggle active" id="seedToggle" onclick="toggleSeedRandom()" title="Rastgele seed">
                            <i class="fas fa-dice"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stil -->
        <div class="panel-section">
            <div class="panel-section-header" onclick="toggleSection(this)">
                <span>Stil</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="panel-section-body">
                <select id="styleSelect" onchange="showStyleSnippets()">
                    {% set ns = namespace(cat='') %}
                    {% for s in styles %}
                    {% if s.category != ns.cat %}
                        {% if ns.cat %}</optgroup>{% endif %}
                        {% set ns.cat = s.category %}
                        <optgroup label="{{ s.category | replace('_', ' ') | title }}">
                    {% endif %}
                    <option value="{{ s.id }}"
                            data-prompt="{{ s.prompt_snippet }}"
                            data-negative="{{ s.negative_snippet }}">{{ s.name }}</option>
                    {% endfor %}
                    {% if styles %}</optgroup>{% endif %}
                </select>
                <div class="style-snippets" id="styleSnippets">
                    <div class="snippet-row">
                        <label>Prompt</label>
                        <p id="stylePrompt" class="snippet-text"></p>
                    </div>
                    <div class="snippet-row">
                        <label>Negative</label>
                        <p id="styleNegative" class="snippet-text"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Perspektif -->
        <div class="panel-section">
            <div class="panel-section-header" onclick="toggleSection(this)">
                <span>Perspektif</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="panel-section-body">
                <select id="perspectiveSelect" onchange="showPerspectiveSnippets()">
                    {% for p in perspectives %}
                    <option value="{{ p.id }}"
                            data-prompt="{{ p.prompt_snippet }}"
                            data-negative="{{ p.negative_snippet }}">{{ p.name }}</option>
                    {% endfor %}
                </select>
                <div class="style-snippets" id="perspectiveSnippets">
                    <div class="snippet-row">
                        <label>Prompt</label>
                        <p id="perspectivePrompt" class="snippet-text"></p>
                    </div>
                    <div class="snippet-row">
                        <label>Negative</label>
                        <p id="perspectiveNegative" class="snippet-text"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Oran -->
        <div class="panel-section">
            <div class="panel-section-header" onclick="toggleSection(this)">
                <span>Oran</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="panel-section-body">
                <select id="ratioSelect" onchange="showRatioInfo()">
                    {% for r in ratios %}
                    <option value="{{ r.id }}"
                            data-width="{{ r.width }}"
                            data-height="{{ r.height }}">{{ r.name }}</option>
                    {% endfor %}
                </select>
                <div class="style-snippets" id="ratioInfo">
                    <div class="snippet-row">
                        <label>Boyut</label>
                        <p id="ratioSize" class="snippet-text"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aydınlatma -->
        <div class="panel-section">
            <div class="panel-section-header" onclick="toggleSection(this)">
                <span>Aydınlatma</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="panel-section-body">
                <select id="lightingSelect" onchange="showLightingSnippets()">
                    {% for l in lightings %}
                    <option value="{{ l.id }}"
                            data-prompt="{{ l.prompt_snippet }}"
                            data-negative="{{ l.negative_snippet }}">{{ l.name }}</option>
                    {% endfor %}
                </select>
                <div class="style-snippets" id="lightingSnippets">
                    <div class="snippet-row">
                        <label>Prompt</label>
                        <p id="lightingPrompt" class="snippet-text"></p>
                    </div>
                    <div class="snippet-row">
                        <label>Negative</label>
                        <p id="lightingNegative" class="snippet-text"></p>
                    </div>
                </div>
            </div>
        </div>

      </div>

        <!-- Generate Button -->
        <button class="btn-generate" onclick="generateImage()">
            <i class="fas fa-magic"></i> Oluştur
        </button>
    </div>

    <!-- ══════ Center - Canvas Area ══════ -->
    <div class="canvas-center">
        <div class="canvas-viewport" id="canvasViewport">
            <div class="canvas-empty" id="canvasEmpty">
                <i class="fas fa-palette"></i>
                <h3>Kanvas</h3>
                <p>Prompt yazın ve görsel oluşturun</p>
            </div>
        </div>

        <!-- Bottom Toolbar -->
        <div class="canvas-toolbar">
            <div class="toolbar-group">
                <button class="toolbar-btn" title="Uzaklaştır" onclick="canvasZoom(-0.1)"><i class="fas fa-search-minus"></i></button>
                <span class="zoom-level" id="zoomLevel">100%</span>
                <button class="toolbar-btn" title="Yakınlaştır" onclick="canvasZoom(0.1)"><i class="fas fa-search-plus"></i></button>
                <button class="toolbar-btn" title="Sığdır" onclick="canvasZoom(0)"><i class="fas fa-expand"></i></button>
            </div>
            <div class="toolbar-group toolbar-actions" id="toolbarActions" style="display:none;">
                <button class="toolbar-btn" title="Görseli indir" onclick="downloadImage()"><i class="fas fa-download"></i></button>
                <button class="toolbar-btn" title="Projeye kaydet" onclick="openProjectModal()"><i class="fas fa-folder-plus"></i></button>
                <button class="toolbar-btn" title="Sketch'e gönder" onclick="sendToSketch()"><i class="fas fa-pencil-ruler"></i></button>
                <button class="toolbar-btn" title="Enhance'a gönder" onclick="sendToEnhance()"><i class="fas fa-expand-arrows-alt"></i></button>
            </div>
        </div>
    </div>

</div>

<!-- ══════ Save to Project Modal ══════ -->
<div class="modal-overlay" id="projectModal">
    <div class="modal-box">
        <div class="modal-header">
            <h3>Projeye Kaydet</h3>
            <button class="modal-close" onclick="closeProjectModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="project-list" id="projectList">
                <div class="modal-loading"><i class="fas fa-spinner fa-spin"></i></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ── Section Toggle ───────────────────────────────

function toggleSection(header) {
    const section = header.parentElement;
    section.classList.toggle('open');
}

// ── LocalStorage Helpers ────────────────────────

const LS_PREFIX = 'mekanai_';
let _initializing = true;

function savePref(key, value) {
    if (_initializing) return;
    localStorage.setItem(LS_PREFIX + key, value);
}

function loadPref(key) {
    return localStorage.getItem(LS_PREFIX + key);
}

function restoreSelect(selectId, lsKey) {
    const saved = loadPref(lsKey);
    if (!saved) return false;
    const el = document.getElementById(selectId);
    const opt = el.querySelector('option[value="' + saved + '"]');
    if (opt && !opt.disabled) {
        el.value = saved;
        return true;
    }
    return false;
}

// ── Provider → Model Filter ─────────────────────

async function filterModels() {
    const providerSelect = document.getElementById('providerSelect');
    const providerId = providerSelect.value;
    const providerKey = providerSelect.selectedOptions[0]?.dataset.key || '';
    const modelSelect = document.getElementById('aiModel');

    // Remove previous dynamic ComfyUI options
    modelSelect.querySelectorAll('.dyn-comfyui').forEach(o => o.remove());

    // ComfyUI: load available checkpoints from server
    if (providerKey === 'comfyui') {
        try {
            const r = await fetch('/api/comfyui-checkpoints');
            const data = await r.json();
            if (data.checkpoints) {
                const dbKeys = new Set();
                modelSelect.querySelectorAll('option').forEach(opt => {
                    if (opt.dataset.provider === providerId) dbKeys.add(opt.value);
                });
                data.checkpoints.forEach(cp => {
                    // Skip if already covered by a DB model
                    const cpLower = cp.toLowerCase();
                    let dup = false;
                    dbKeys.forEach(k => { if (cpLower.includes(k.replace(/_/g, ''))) dup = true; });
                    if (dup) return;
                    const opt = document.createElement('option');
                    opt.value = cp;
                    opt.textContent = cp.replace(/\.[^.]+$/, '');
                    opt.classList.add('dyn-comfyui');
                    opt.dataset.provider = providerId;
                    opt.dataset.steps = '20';
                    opt.dataset.cfg = '7';
                    opt.dataset.sampler = 'Euler';
                    modelSelect.appendChild(opt);
                });
            }
        } catch(e) { console.error('ComfyUI checkpoints:', e); }
    }

    // Standard filtering by provider
    const options = modelSelect.querySelectorAll('option');
    let firstVisible = null;
    options.forEach(opt => {
        const match = opt.dataset.provider === providerId;
        opt.style.display = match ? '' : 'none';
        opt.disabled = !match;
        if (match && !firstVisible) firstVisible = opt;
    });

    if (firstVisible) {
        modelSelect.value = firstVisible.value;
        applyModelDefaults();
    }
    savePref('provider', providerId);
    checkProviderStatus();
}

function applyModelDefaults() {
    const opt = document.getElementById('aiModel').selectedOptions[0];
    if (!opt) return;
    const steps = opt.dataset.steps;
    const cfg = opt.dataset.cfg;
    if (steps) {
        document.getElementById('stepsRange').value = steps;
        document.getElementById('stepsVal').textContent = steps;
    }
    if (cfg) {
        document.getElementById('cfgRange').value = cfg;
        document.getElementById('cfgVal').textContent = cfg;
    }
    savePref('model', opt.value);
}

// ── Style Snippets ──────────────────────────────

function showStyleSnippets() {
    const opt = document.getElementById('styleSelect').selectedOptions[0];
    if (!opt) return;
    document.getElementById('stylePrompt').textContent = opt.dataset.prompt || '—';
    document.getElementById('styleNegative').textContent = opt.dataset.negative || '—';
    savePref('style', opt.value);
}

// ── Perspective Snippets ────────────────────────

function showPerspectiveSnippets() {
    const opt = document.getElementById('perspectiveSelect').selectedOptions[0];
    if (!opt) return;
    document.getElementById('perspectivePrompt').textContent = opt.dataset.prompt || '—';
    document.getElementById('perspectiveNegative').textContent = opt.dataset.negative || '—';
    savePref('perspective', opt.value);
}

// ── Ratio Info ──────────────────────────────────

function showRatioInfo() {
    const opt = document.getElementById('ratioSelect').selectedOptions[0];
    if (!opt) return;
    document.getElementById('ratioSize').textContent = opt.dataset.width + ' x ' + opt.dataset.height + ' px';
    savePref('ratio', opt.value);
}

// ── Lighting Snippets ───────────────────────────

function showLightingSnippets() {
    const opt = document.getElementById('lightingSelect').selectedOptions[0];
    if (!opt) return;
    document.getElementById('lightingPrompt').textContent = opt.dataset.prompt || '—';
    document.getElementById('lightingNegative').textContent = opt.dataset.negative || '—';
    savePref('lighting', opt.value);
}

// ── Seed Toggle (Random / Fixed) ────────────────

function toggleSeedRandom() {
    const btn = document.getElementById('seedToggle');
    const input = document.getElementById('seedInput');
    const isRandom = btn.classList.toggle('active');

    savePref('seed_random', isRandom ? 'true' : 'false');
    if (isRandom) {
        input.value = -1;
        input.disabled = true;
    } else {
        input.disabled = false;
    }
}

function initSeed() {
    const isRandom = loadPref('seed_random') !== 'false';
    const btn = document.getElementById('seedToggle');
    const input = document.getElementById('seedInput');

    if (isRandom) {
        btn.classList.add('active');
        input.value = -1;
        input.disabled = true;
    } else {
        btn.classList.remove('active');
        input.disabled = false;
    }
}

// ── Init (restore saved preferences) ────────────

// Provider & Model (order matters: provider first, then filter, then restore model)
restoreSelect('providerSelect', 'provider');
filterModels();
if (restoreSelect('aiModel', 'model')) {
    applyModelDefaults();
}

// Dropdowns
restoreSelect('styleSelect', 'style');
showStyleSnippets();
restoreSelect('perspectiveSelect', 'perspective');
showPerspectiveSnippets();
restoreSelect('ratioSelect', 'ratio');
showRatioInfo();
restoreSelect('lightingSelect', 'lighting');
showLightingSnippets();
initSeed();
_initializing = false;

// ── Canvas Zoom ──────────────────────────────────

let currentZoom = 1.0;

function canvasZoom(delta) {
    const img = document.getElementById('canvasImage');
    if (!img) return;

    if (delta === 0) {
        currentZoom = 1.0;
    } else {
        currentZoom = Math.max(0.1, Math.min(3.0, currentZoom + delta));
    }

    img.style.transform = `scale(${currentZoom})`;
    document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
}

// ── Generate ─────────────────────────────────────

let lastImageBase64 = null;

function generateImage() {
    const prompt = document.getElementById('promptInput').value;
    if (!prompt) {
        alert('Lütfen bir prompt girin');
        return;
    }

    const ratioOpt = document.getElementById('ratioSelect').selectedOptions[0];
    const btn = document.querySelector('.btn-generate');
    const viewport = document.getElementById('canvasViewport');

    const modelOpt = document.getElementById('aiModel').selectedOptions[0];
    const providerOpt = document.getElementById('providerSelect').selectedOptions[0];
    const params = {
        prompt: prompt,
        negative_prompt: document.getElementById('negativePrompt').value,
        model: modelOpt.value,
        provider_key: providerOpt?.dataset.key || '',
        sampler: modelOpt.dataset.sampler || 'DPM++ 2M Karras',
        width: parseInt(ratioOpt.dataset.width),
        height: parseInt(ratioOpt.dataset.height),
        steps: parseInt(document.getElementById('stepsRange').value),
        cfg_scale: parseFloat(document.getElementById('cfgRange').value),
        seed: parseInt(document.getElementById('seedInput').value),
        style_id: parseInt(document.getElementById('styleSelect').value),
        perspective_id: parseInt(document.getElementById('perspectiveSelect').value),
        ratio_id: parseInt(document.getElementById('ratioSelect').value),
        lighting_id: parseInt(document.getElementById('lightingSelect').value),
    };

    // Loading state
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Oluşturuluyor...';
    viewport.innerHTML = '<div class="canvas-loading"><i class="fas fa-spinner fa-spin"></i><p>Oluşturuluyor... Bu işlem biraz sürebilir.</p></div>';

    // 5-minute timeout for long AI generation
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 300000);

    fetch('/api/generate-image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(params),
        signal: controller.signal
    })
    .then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
        return r.json();
    })
    .then(data => {
        if (data.status === 'success' && data.image_base64) {
            lastImageBase64 = data.image_base64;

            // Show generated image
            viewport.innerHTML = `<img src="data:image/png;base64,${data.image_base64}" alt="Generated" id="canvasImage">`;
            currentZoom = 1.0;
            document.getElementById('zoomLevel').textContent = '100%';
            document.getElementById('toolbarActions').style.display = '';

            // Update seed if returned
            if (data.seed && data.seed > 0) {
                if (!document.getElementById('seedToggle').classList.contains('active')) {
                    document.getElementById('seedInput').value = data.seed;
                }
            }

            // Show elapsed time
            if (data.elapsed) {
                console.log(`Oluşturma süresi: ${data.elapsed}s`);
            }
        } else {
            viewport.innerHTML = `<div class="canvas-empty"><i class="fas fa-exclamation-triangle"></i><h3>Hata</h3><p>${data.message || 'Görsel oluşturulamadı'}</p></div>`;
        }
    })
    .catch(err => {
        console.error('Generate fetch error:', err);
        const pName = providerOpt?.textContent?.trim() || 'AI';
        const detail = err.name === 'AbortError' ? 'İstek zaman aşımına uğradı (5dk)' : (err.message || 'Bağlantı hatası');
        viewport.innerHTML = `<div class="canvas-empty"><i class="fas fa-exclamation-triangle"></i><h3>Bağlantı Hatası</h3><p>${pName}: ${detail}</p></div>`;
    })
    .finally(() => {
        clearTimeout(timeoutId);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-magic"></i> Oluştur';
    });
}

// ── Image Actions ───────────────────────────────

function downloadImage() {
    if (!lastImageBase64) return;
    const a = document.createElement('a');
    a.href = 'data:image/png;base64,' + lastImageBase64;
    a.download = 'mekanai_' + Date.now() + '.png';
    a.click();
}

function openProjectModal() {
    if (!lastImageBase64) return;
    const modal = document.getElementById('projectModal');
    const list = document.getElementById('projectList');
    list.innerHTML = '<div class="modal-loading"><i class="fas fa-spinner fa-spin"></i></div>';
    modal.classList.add('open');

    fetch('/api/projects')
        .then(r => r.json())
        .then(data => {
            if (!data.projects || data.projects.length === 0) {
                list.innerHTML = '<div class="project-empty">Henüz proje yok.<br>Önce Projects sayfasından proje oluşturun.</div>';
                return;
            }
            list.innerHTML = data.projects.map(p => `
                <div class="project-item" onclick="saveToProject(${p.id})">
                    <i class="fas fa-folder"></i>
                    <div class="project-item-info">
                        <div class="project-item-name">${p.name}</div>
                        <div class="project-item-meta">${p.description || ''}</div>
                    </div>
                </div>
            `).join('');
        })
        .catch(() => {
            list.innerHTML = '<div class="project-empty">Projeler yüklenemedi.</div>';
        });
}

function closeProjectModal() {
    document.getElementById('projectModal').classList.remove('open');
}

function saveToProject(projectId) {
    if (!lastImageBase64) return;
    const list = document.getElementById('projectList');
    list.innerHTML = '<div class="modal-loading"><i class="fas fa-spinner fa-spin"></i></div>';

    fetch('/api/save-to-project', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            project_id: projectId,
            image_base64: lastImageBase64,
            settings: {
                prompt: document.getElementById('promptInput').value,
                negative_prompt: document.getElementById('negativePrompt').value,
                style_id: parseInt(document.getElementById('styleSelect').value),
                perspective_id: parseInt(document.getElementById('perspectiveSelect').value),
                ratio_id: parseInt(document.getElementById('ratioSelect').value),
                lighting_id: parseInt(document.getElementById('lightingSelect').value),
            }
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            list.innerHTML = '<div class="project-empty"><i class="fas fa-check" style="color:var(--primary-color);font-size:24px;"></i><br>Kaydedildi!</div>';
            setTimeout(closeProjectModal, 1000);
        } else {
            list.innerHTML = '<div class="project-empty">Hata: ' + (data.message || 'Kaydedilemedi') + '</div>';
        }
    })
    .catch(() => {
        list.innerHTML = '<div class="project-empty">Bağlantı hatası.</div>';
    });
}

function sendToSketch() {
    if (!lastImageBase64) return;
    sessionStorage.setItem('mekanai_sketch_source', lastImageBase64);
    window.location.href = '/sketch';
}

function sendToEnhance() {
    if (!lastImageBase64) return;
    sessionStorage.setItem('mekanai_enhance_image', lastImageBase64);
    window.location.href = '/enhance';
}

// Close modal on overlay click
document.getElementById('projectModal').addEventListener('click', function(e) {
    if (e.target === this) closeProjectModal();
});

// ── Provider Connection Check ───────────────────
function checkProviderStatus() {
    const providerKey = document.getElementById('providerSelect').selectedOptions[0]?.dataset.key || 'local';
    const endpoint = providerKey === 'comfyui' ? '/api/comfyui-status' : '/api/sd-status';
    const label = providerKey === 'comfyui' ? 'ComfyUI' : 'SD WebUI';

    fetch(endpoint)
        .then(r => r.json())
        .then(data => {
            const btn = document.querySelector('.btn-generate');
            if (!data.connected) {
                btn.title = label + ' bağlantısı yok';
                btn.style.opacity = '0.6';
            } else {
                btn.title = 'Görsel oluştur';
                btn.style.opacity = '1';
            }
        })
        .catch(() => {});
}

checkProviderStatus();
</script>
{% endblock %}
